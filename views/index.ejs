<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>YT to MP3 Editor</title>
  <link rel="stylesheet" href="/css/style.css" />
</head>
<body>
  <div class="container">
    <header>
      <h1>YouTube to MP3 Editor</h1>
    </header>

    <main>
      <!-- Converter Card -->
      <form action="/convert-mp3" method="POST" id="form">
        <section class="card converter-form">
          <label for="youtube-url">YouTube Link ID</label>
          <input type="text" id="youtube-url" name="videoID" placeholder="Paste YouTube Link ID..." />
          
          <button id="convert-btn">Convert</button>

          <div class="bottom-container">
            <!-- Checks if conversion was successful -->
            <% if (typeof converterSuccess !== "undefined" && converterSuccess) { %>
              <div class="success">
                <!-- Inserts title of video -->
                <% if (typeof song_title !== "undefined" && song_title) { %>
                  <p><%= song_title %></p>
                <% } %>
                <!-- Inserts song link for download -->
                <% if (typeof song_link !== "undefined" && song_link) { %>
                  <a href="<%= song_link %>" id="download-btn" download>DOWNLOAD</a>
                <% } %>
              </div>

              <!-- Error message for failed conversion -->
              <% } else if(typeof converterSuccess != "undefined" && !converterSuccess) { %>
                <div class="errors">
                  <p><%= converterMessage %></p>
                </div>
              <% } %>
          </div>
        </section>
      </form>


      <!-- Metadata Editor Card -->
      <section class="card metadata-editor">
        <h2>MP3 Metadata Editor</h2>

        <form id="metadata-form" action="/update-metadata" method="POST" enctype="multipart/form-data">
          
          <div class="form-group">
            <label for="mp3-file">Upload MP3 File</label>
            <input type="file" id="mp3-file" name="mp3File" accept=".mp3" required />
          </div>

          <div class="form-group">
            <label for="cover-image">Cover Image</label>
            <input type="file" id="cover-image" name="coverImage" accept="image/*" />
          </div>

          <div class="form-grid">
            <div class="form-group">
              <label for="title">Title</label>
              <input type="text" id="title" name="title" placeholder="Untitled" />
            </div>

            <div class="form-group">
              <label for="artist">Artist</label>
              <input type="text" id="artist" name="artist" placeholder="Unknown Artist [Local Copy]" />
            </div>

            <div class="form-group">
              <label for="album">Album</label>
              <input type="text" id="album" name="album" placeholder="Unknown Album [Local Copy]" />
            </div>

            <div class="form-group">
              <label for="year">Year</label>
              <input type="number" id="year" name="year" placeholder="YYYY" />
            </div>

            <div class="form-group">
              <label for="genre">Genre</label>
              <input type="text" id="genre" name="genre" placeholder="Other" />
            </div>
          </div>

          <button type="submit" id="save-metadata-btn">Save Metadata</button>
        </form>

        <div id="metadataResult">
          <!-- Checks if metadata update was successful -->
          <% if (typeof metadataSuccess !== "undefined" && metadataSuccess) { %>
            <div class="success">
              <!-- Success message and link to updated MP3 -->
              <p><%= metadataMessage %></p>
              <% if (typeof download_link !== "undefined" && download_link) { %>
                <a href="<%= download_link %>" download>Download Updated MP3</a>
              <% } %>

            </div>
          <!-- Failure message -->
          <% } else if (typeof metadataSuccess !== "undefined" && !metadataSuccess) { %>
            <div class="errors">
              <p><%= metadataMessage %></p>
            </div>
          <% } %>
        </div>

        </div>
      </section>


      <!-- History Card -->
      <section class="card history-section">
        <h2>Editor History</h2>
        <ul class="history-list">
          <!-- Loops over history queue and renders each available action -->
          <% if (history && history.length > 0) { %>
            <% history.forEach((item, i) => { %>
              <% if (item.type === "conversion") { %>
                <li>
                  <button type="button" class="load-conversion" data-videoid="<%= item.videoID %>">
                    Load: <%= item.songTitle %>
                  </button>
                </li>
              <% } else if (item.type === "metadata") { %>
                <li>
                  <!-- Embeds data to be auto-filled -->
                  <button type="button" class="load-metadata"
                    data-title="<%= item.metadata.title %>"
                    data-artist="<%= item.metadata.artist %>"
                    data-album="<%= item.metadata.album %>"
                    data-year="<%= item.metadata.year %>"
                    data-genre="<%= item.metadata.genre %>"
                  >
                    Load Metadata: <%= item.fileName %>
                  </button>
                </li>
              <% } %>
            <% }); %>
          <% } else { %>
            <li>No recent actions.</li>
          <% } %>
        </ul>

        <ul class="history-list">

          <script>

  // Loads conversion ID of a selected successful conversion
  document.querySelectorAll(".load-conversion").forEach(btn => {
    btn.addEventListener("click", () => {
      const videoID = btn.dataset.videoid;
      document.getElementById("youtube-url").value = videoID;
    });
  });

  // Load metadata from selected successful metadata update
  document.querySelectorAll(".load-metadata").forEach(btn => {
    btn.addEventListener("click", () => {
      document.getElementById("title").value = btn.dataset.title || "";
      document.getElementById("artist").value = btn.dataset.artist || "";
      document.getElementById("album").value = btn.dataset.album || "";
      document.getElementById("year").value = btn.dataset.year || "";
      document.getElementById("genre").value = btn.dataset.genre || "";
    });
  });
</script>
</body>
</html>
